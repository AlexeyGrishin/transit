<!DOCTYPE html>

<html>
<head>
  <title>transit.doc.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco-linear.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>transit.doc.coffee</h1>
        

        
      </div>

      
        
        <p><strong>transit</strong> is a express-like framework for im bots. It allows to process the commands received by ICQ (or other IM service)
then interpret them and respond somehow to the user. Also it may send some messages to the users in background,
not only as response to the request.</p>
<p>In general it works the following way:</p>
<pre><code>         &#39;hello&#39;   Middleware   (req, res)                 sendBack &#39;hi!&#39;
Client -----------&gt; Middleware -----------&gt; User handler ---------------\
                     Middleware                                         |
                                                                        |
            &#39;&lt;b&gt;HI!&lt;/b&gt;&#39;            Formatter                           |
Client &lt;---------------------------- Formatter &lt;------------------------/
                                      Formatter</code></pre>
<h2>Transit application initialization</h2>
<p><strong>transit</strong> app is initialized the similar way as express app:</p>

        
          <div class='highlight'><pre>transit = require(<span class="string">'transit'</span>)
app = transit()</pre></div>
        
      
        
        <h2>Clients</h2>
<p><strong>Client</strong> provides interface between end user and <strong>transit</strong> - receives messages and allows to send response back.</p>
<p><strong>Client</strong> shall be registered with <strong>use</strong> method call. There shall be an object with several methods defined:</p>

        
          <div class='highlight'><pre>app.use {</pre></div>
        
      
        
        <p><em>install</em> is called by <strong>transit</strong></p>

        
          <div class='highlight'><pre>  install: (transit) -&gt;
    transit.client @</pre></div>
        
      
        
        <p>The provided callback shall be called when external client sends a message to server
Its signature is <code>function(userId, data, callback)</code></p>

        
          <div class='highlight'><pre>  receive: (<span class="property">@callback</span>) -&gt;</pre></div>
        
      
        
        <p><em>start</em> method shall start listening to the external clients and call provided callback</p>

        
          <div class='highlight'><pre>  start: -&gt;</pre></div>
        
      
        
        <p><em>sendBack</em> method is used to send data back to client</p>

        
          <div class='highlight'><pre>  sendBack: (userId, data, cb) -&gt;
}</pre></div>
        
      
        
        <p><a href="commandLine.html">Learn more</a> on example of command line client</p>
<p>There are 2 builtin clients:</p>
<ol>
<li><a href="commandLine.doc.html">Command line client</a></li>
<li><a href="icq.doc.html">ICQ client</a></li>
</ol>
<h2>Middleware</h2>
<p><strong>Middleware</strong> is called on each request before your application logic. It could be used to perform some preliminary
actions, extract something, and so on.</p>
<p><strong>Middleware</strong> shall be registered with <strong>use</strong> method call. There are 2 ways to define middleware</p>
<h5>function middleware</h5>
<p>It accepts <strong>Request</strong> object, <strong>Response</strong> object and <strong>next</strong> callback. <strong>next</strong> callback shall be called anyway, otherwise
message will not be processed.</p>

        
          <div class='highlight'><pre>app.use (req, res, next) -&gt;</pre></div>
        
      
        
        <p>The following properties are available in request by default:</p>
<ul>
<li><em>user</em> - user id (ICQ number, for example)</li>
<li><em>command</em> - special command sent by client. For example &#39;exit&#39; is sent when user logs out</li>
<li><em>data</em> - string message from end-user. May be undefined in case of command.</li>
<li><em>handlers</em> - list of user handlers. Use it if you&#39;d like to write your own command parser</li>
<li><em>handler</em> - is user handler that will be called to process this message</li>
</ul>

        
          <div class='highlight'><pre>  console.log req.user
  console.log req.command
  console.log req.data
  console.log req.handlers
  console.log req.handler</pre></div>
        
      
        
        <ul>
<li><em>session</em> - user&#39;s session object. Exists only when <strong>sessions</strong> middleware is included.</li>
</ul>

        
          <div class='highlight'><pre>  console.log req.session</pre></div>
        
      
        
        <p>You may change properties of request or response objects, but not by direct assignment - instead you need to call
&#39;attr&#39; method</p>

        
          <div class='highlight'><pre>  req.data = <span class="string">"["</span> + req.data + <span class="string">"]"</span>         <span class="comment"># WRONG</span>
  req.attr(<span class="string">"data"</span>, <span class="string">"["</span> + req.data + <span class="string">"]"</span>)  <span class="comment"># Right</span></pre></div>
        
      
        
        <p>With <strong>Response</strong> object you may send something back to user. You do not need to specify user id</p>

        
          <div class='highlight'><pre>  res.sendBack <span class="string">"Data received, processing..."</span></pre></div>
        
      
        
        <p>Do not forget to call the next()!</p>

        
          <div class='highlight'><pre>  next()</pre></div>
        
      
        
        <h5>object middleware</h5>
<p>You need to define &#39;install&#39; method which shall return middleware function. Install method accepts <strong>transit</strong> application
instance.</p>

        
          <div class='highlight'><pre>app.use {
  install: (transit) -&gt;</pre></div>
        
      
        
        <p>You may use it to add new properties to request/response. Without this extension you&#39;ll get error if you call &#39;attr&#39; with
unknown attrbute name</p>

        
          <div class='highlight'><pre>    transit.extendRequest <span class="string">"myRequestProperty"</span>
    (req, res, next) -&gt;
      req.attr <span class="string">"myRequestProperty"</span>, <span class="string">"dummy"</span>
      next()
}</pre></div>
        
      
        
        <h2>User handler</h2>
<p><strong>User handler</strong> is what your application do on specific command.</p>
<p>Initially you may define global handler which is called on each command.</p>

        
          <div class='highlight'><pre>app.receive (req, res) -&gt;
  res.sendBack <span class="string">"Echoed: <span class="subst">#{req.data}</span>"</span></pre></div>
        
      
        
        <p>Note that for user handler you do not have &#39;next&#39; callback. Instead you need to call one of the <strong>Response</strong> object methods -
<strong>sendBack</strong> if you&#39;d like to send something to client or <strong>done</strong> if not.</p>
<p>If you set up special middleware for command parsing then you may provide user handlers for specific commands.</p>
<p>There is a builtin middleware for that purposes - <a href="commandParser.doc.html">command parser</a></p>

        
          <div class='highlight'><pre>app.use transit.commandParser
app.receive <span class="string">'hello'</span>, (req, res) -&gt; res.sendBack <span class="string">'hi'</span>
app.receive <span class="string">'iam {name}'</span>, (req, res) -&gt; res.sendBack <span class="string">"hi <span class="subst">#{req.name}</span>"</span>
app.receive <span class="string">'wishes {{list}}'</span>, (req, res) -&gt; res.sendBack <span class="string">"your wish list has <span class="subst">#{req.list.length}</span> items"</span></pre></div>
        
      
        
        <p><a href="commandParser.doc.html">Learn more</a></p>
<h2>Formatter</h2>
<p>Before sending data back to client you may want to format it somehow. You may define formatters for that purpose:</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">niceFormat</span></span> = (data, options, callback) -&gt;
  braces = options?.braces ? <span class="string">"[]"</span>
  formattedData = braces[<span class="number">0</span>] + data + braces[<span class="number">1</span>]
  callback <span class="literal">null</span>, formattedData

app.formatOutput niceFormat</pre></div>
        
      
        
        <p>Then it will be used when you call <strong>sendBack</strong></p>

        
          <div class='highlight'><pre>app.sendBack <span class="number">11</span>, <span class="string">"hi!"</span>, -&gt;
app.receive (req, res) -&gt;
  res.sendBack req.data, braces: <span class="string">"&lt;&gt;"</span></pre></div>
        
      
        
        <p>Or you may define several formatters with their own names and call them by name</p>

        
          <div class='highlight'><pre>app.formatOutput <span class="string">"niceFormat"</span>, niceFormat

app.sendBack.niceFormat <span class="number">11</span>, <span class="string">"hi!"</span>, -&gt;
app.receive (req, res) -&gt;
  res.niceFormat req.data, braces: <span class="string">"&lt;&gt;"</span></pre></div>
        
      
        
        <p><a href="formatterChain.doc.html">Learn more</a></p>
<h2>Builtin middlewares/formatters</h2>
<p><a href="commandParser.doc.html">Command parser</a></p>

        
          <div class='highlight'><pre>app.use transit.commandParser()</pre></div>
        
      
        
        <p><a href="doNotWaitForResponse.doc.html">Do not wait for response</a></p>

        
          <div class='highlight'><pre>app.use transit.doNotWaitForResponse()</pre></div>
        
      
        
        <p><a href="echo.html">Echoes all messages</a></p>

        
          <div class='highlight'><pre>app.use transit.echo()</pre></div>
        
      
        
        <p><a href="html2txt.html">Converts html to txt</a></p>

        
          <div class='highlight'><pre>app.use transit.html2txt()</pre></div>
        
      
        
        <p>Introduces sessions (TBD, see <a href="icq.doc.html#section-2">example of usage</a> )</p>

        
          <div class='highlight'><pre>app.use transit.sessions()</pre></div>
        
      
        
        <p><a href="autohelp.html">Shows help on commands</a></p>

        
          <div class='highlight'><pre>app.use transit.autohelp()</pre></div>
        
      
        
        <p><a href="formatterChain.doc.html">Allows to compose a chain of formatters</a></p>

        
          <div class='highlight'><pre>app.use transit.chain()</pre></div>
        
      
        
        <h2>Examples</h2>
<ol>
<li><a href="icq.doc.html">for ICQ</a>, but it requires real ICQ account to use.</li>
<li><a href="commandLine.doc.html">for command line client</a></li>
</ol>

        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
