<!DOCTYPE html>

<html>
<head>
  <title>commandLine.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>commandLine.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This is client middleware example.
Client middleware receives some data from end-user, transfers it to the transit and allows transit send something back.
Also client middleware can send some custom commands. By default transit does not understand any command, but some
middlewares may process them. Commands are not passed to user handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>readline = require(<span class="string">'readline'</span>)
rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

userId = <span class="number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Each client middleware shall provide constructor function which may accept some options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>module.<span class="function"><span class="title">exports</span></span> = (options = {}) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>When <em>transit.use</em> is called with object the <em>transit</em> calls <em>install</em> method of that object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  install: (transit) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>... and client middleware shall register itself as a client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transit.client @</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The provided callback shall be called when external client sends a message to server
Its signature is <code>function(userId, data, callback)</code> where
- userId - is any value or object which identifies the client. <strong>transit</strong> does not interpret it somehow.
- data - could be string - in this case it is interpreted as data that shall be processed by server handlers.
         or it could be an object with special command
- callback - to be called in case of error or <em>when data/command processing is started</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  receive: (<span class="property">@callback</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>This method shall start listening to the external clients and call provided callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: -&gt;
    rl.<span class="literal">on</span> <span class="string">'line'</span>, (line) =&gt;
      line = line.trim()
      <span class="keyword">if</span> line.indexOf(<span class="string">":uid"</span>) == <span class="number">0</span>
        userId = line.split(<span class="string">" "</span>)[<span class="number">1</span>]
        console.log <span class="string">"User id changed to "</span> + userId
        rl.prompt()
      <span class="keyword">else</span> <span class="keyword">if</span> line == <span class="string">':exit'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This is example of sending command - the object is passed as <code>data</code> argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@callback</span> userId, command: <span class="string">"exit"</span>, (err) -&gt;
          rl.prompt()
      <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This is just a text from client - send it to transit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@callback</span> userId, line, (err) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>This callback is called <em>after server started processing the request</em> or <em>in case of error</em>.
The response from server could be sent before or after this callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          console.error err <span class="keyword">if</span> err
          console.log <span class="string">"OK"</span> <span class="keyword">if</span> options.ack
          rl.prompt()
    rl.prompt()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>This method is used to send data back to client</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sendBack: (userId, data, cb) -&gt;
    console.log userId + <span class="string">": "</span> + data
    cb()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
